@functions{
    public static string SqlQuery(string order)
    {
        var orderPart = "";
        switch(order)
        {
            case "Ship Name DESC":
                orderPart = "[Ship Name] DESC";
                break;
            case "Ship Country ASC":
                orderPart = "[Ship Country] ASC";
                break;
            case "Ship Country DESC":
                orderPart = "[Ship Country] DESC";
                break;
            case "Order Date ASC":
                orderPart = "[Order Date] ASC";
                break;
            case "Order Date DESC":
                orderPart = "[Order Date] DESC";
                break;
            case "Shipped ASC":
                orderPart = "[Shipped] ASC";
                break;
            case "Shipped DESC":
                orderPart = "[Shipped] DESC";
                break;
            default:
                orderPart = "[Ship Name] ASC";
                break;
        }
        return "SELECT * FROM Orders ORDER BY " + orderPart + 
            " OFFSET @0 ROWS FETCH NEXT @1 ROWS ONLY";
    }
}

@{
    try
    {
        System.Threading.Thread.Sleep(200);
        var db = Database.Open("Orders");
        var recCount = db.QueryValue("SELECT COUNT(*) FROM Orders");
        var orders = db.Query(SqlQuery(Request["jtSorting"]),
                Request["jtStartIndex"], Request["jtPageSize"]).ToList();
        var json = Json.Encode(new{Result = "OK", Records = orders, TotalRecordCount = recCount});
        Response.Write(json);
    }
    catch (Exception ex)
    {
        var json = Json.Encode(new{Result = "ERROR", Message = ex.Message});
        Response.Write(json);
    }
}
